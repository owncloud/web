---
kind: pipeline
name: lint-test

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: lint-test
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - yarn run lint

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUIFavorites

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIFavorites</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFavorites
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUIFiles

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUIFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIFiles</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFiles
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUILogin

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUILogin</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUILogin
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUINotifications

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUINotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUINotifications</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUINotifications
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUIRenameFiles

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUIRenameFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIRenameFiles</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFiles
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUIRenameFolders

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUIRenameFolders
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIRenameFolders</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFolders
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUISharingInternalGroups

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingInternalGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalGroups
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUISharingInternalUsers

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUISharingInternalUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingInternalUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUITrashbin

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUITrashbin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUITrashbin</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUITrashbin
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-webUIUpload

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIUpload</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  environment:
    TEST_CONTEXT: webUIUpload
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-XGAPortraitResolution

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    SCREEN_RESOLUTION: 768x1024
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>${TEST_CONTEXT}</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: acceptance-IphoneResolution

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    SCREEN_RESOLUTION: 375x812
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>${TEST_CONTEXT}</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - echo "\n</p></details>" >> comments.file
  - more comments.file
  when:
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
name: publish-npm-and-demo-system

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: build-docker-image
  pull: always
  image: toolhippie/docker:latest
  commands:
  - docker build -t owncloud/phoenix:${DRONE_COMMIT_SHA}-${DRONE_BUILD_NUMBER} .
  environment:
    DOCKER_HOST: tcp://docker:2375
  when:
    event:
    - push

- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-release
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - make -f Makefile.release dist
  when:
    event:
    - push

- name: deploy-staging
  pull: always
  image: drillster/drone-rsync:latest
  settings:
    delete: true
    hosts: pixie.owncloud.systems
    port: 22
    recursive: true
    script:
    - sudo docker exec phoenix occ maintenance:mode --on
    - sudo rsync -az --chown=www-data:www-data -r --del --exclude config.json /home/deploy/phoenix/ /var/lib/phoenix/apps/phoenix
    - sudo docker exec phoenix occ maintenance:mode --off
    - sudo docker exec phoenix owncloud migrate
    source: dist/
    target: /home/deploy/phoenix
    user: deploy
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
  when:
    branch:
    - master
    event:
    - push

services:
- name: docker
  pull: if-not-exists
  image: docker:18.04-dind

trigger:
  ref:
  - refs/merge-requests/**
  - refs/heads/master

---

kind: pipeline
name: acceptance-webUILogin-saucelabs

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-server
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: ${DB_TYPE=mysql}
    db_name: ${DB_NAME=owncloud}
    db_password: owncloud
    db_type: ${DB_TYPE=mysql}
    db_username: owncloud
    version: ${OC_VERSION=daily-master-qa}

- name: clone-oauth
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2

- name: configure-server
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix:8300
  - php occ log:manage --level 0
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix:8300/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix:8300/oidc-callback.html
  - yarn run acceptance-tests-sauce
  environment:
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip
    SAUCE_USERNAME:
      from_secret: sauce_username
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key

services:
- name: phoenix
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  commands:
  - mkdir dist
  - make run SERVER_HOST=phoenix:8300

- name: owncloud
  pull: always
  image: owncloudci/php:${PHP_VERSION=7.1}
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: saucelabs
  pull: if-not-exists
  image: henrrich/docker-sauce-connect:latest
  commands:
    - /usr/local/sauce-connect/bin/sc
  environment:
    SAUCE_USERNAME:
      from_secret: sauce_username
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

...
